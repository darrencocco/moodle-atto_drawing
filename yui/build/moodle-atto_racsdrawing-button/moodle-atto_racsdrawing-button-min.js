YUI.add("moodle-atto_racsdrawing-button",function(e,t){var n="atto_racsdrawing",r={DRAWLINE:"atto_racsdrawing_drawline",ERASER:"atto_racsdrawing_eraser",CANVAS:"atto_racsdrawing_canvas",SAVE:"atto_racsdrawing_save",INPUTALT:"atto_racsdrawing_inputalt",INPUTWIDTH:"atto_racsdrawing_inputwidth",INPUTHEIGHT:"atto_racsdrawing_inputheight",INPUTALIGNMENT:"atto_racsdrawing_inputalignment",TOOLS:"atto_racsdrawing_toolspallet",FORM:"atto_racsdrawing_form",TOOLSGROUP:"atto_racsdrawing_tools",BRUSHSIZEGROUP:"atto_racsdrawing_brushes",BRUSH1:"atto_racsdrawing_brush1",BRUSH2:"atto_racsdrawing_brush2",BRUSH3:"atto_racsdrawing_brush3",BRUSH4:"atto_racsdrawing_brush4",ICON:"atto_racsdrawing_toolpalleticon",PALLETSECTIONTITLE:"atto_racsdrawing_toolpallettitle",COLOURGROUP:"atto_racsdrawing_colours",COLOUR:"atto_racsdrawing_colour",COLOUR1:"atto_racsdrawing_colour1",COLOUR2:"atto_racsdrawing_colour2",COLOUR3:"atto_racsdrawing_colour3",COLOUR4:"atto_racsdrawing_colour4",COLOUR5:"atto_racsdrawing_colour5",COLOUR6:"atto_racsdrawing_colour6",COLOUR7:"atto_racsdrawing_colour7",COLOUR8:"atto_racsdrawing_colour8",SELECTEDCOLOUR:"atto_racsdrawing_colour_selected",SELECTEDTOOL:"atto_racsdrawing_tool_selected",BRUSH:"atto_racsdrawing_brush",SELECTEDBRUSHSIZE:"atto_racsdrawing_brush_selected",TOOL:"atto_racsdrawing_tool"},i={ISPERCENT:/\d+%/},s=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],o='<form class="{{CSS.FORM}} atto_form"><canvas class="{{CSS.CANVAS}}" width="800" height="600"></canvas><div class="{{CSS.TOOLS}}"><div class="{{CSS.TOOLSGROUP}}"><h4 class="{{CSS.PALLETSECTIONTITLE}}">{{get_string "title_tools" component}}</h4><table><tbody><tr><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.DRAWLINE}}" data-tool="draw" src="{{image_url "pencil" component}}" title="{{get_string "pencil" component}}"/></div></td><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.ERASER}}" data-tool="erase" src="{{image_url "eraser" component}}" title="{{get_string "eraser" component}}"/></div></td</tr><tr><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.TEXT}}" data-tool="text" src="{{image_url "entertext" component}}"  title="{{get_string "enter_text" component}}"/></div></td><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.BOX}}" data-tool="box" src="{{image_url "drawbox" component}}" title="{{get_string "draw_box" component}}"/></div></td</tr><tr><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.SAVE}}" data-tool="save" src="{{image_url "save" component}}" title="{{get_string "save" component}}"/></div></td><td><div class="{{CSS.ICON}}"><img class="{{CSS.TOOL}} {{CSS.CANCEL}}" data-tool="cancel" src="{{image_url "cancel" component}}" title="{{get_string "cancel" component}}"/></div></td</tr></tbody></table></div><div class="{{CSS.BRUSHSIZEGROUP}}"><h4 class="{{CSS.PALLETSECTIONTITLE}}">{{get_string "title_tool_sizes" component}}</h4><table><tbody><tr><td><div class="{{CSS.ICON}}" title="{{get_string "brush1" component}}"><div class="{{CSS.BRUSH}} {{CSS.BRUSH1}}" title="{{get_string "brush1" component}}"></div></button></td><td><div class="{{CSS.ICON}}" title="{{get_string "brush2" component}}"><div class="{{CSS.BRUSH}} {{CSS.BRUSH2}}" title="{{get_string "brush2" component}}"></div></div></td</tr><tr><td><div class="{{CSS.ICON}}" title="{{get_string "brush3" component}}"><div class="{{CSS.BRUSH}} {{CSS.BRUSH3}}" title="{{get_string "brush3" component}}"></div></div></td><td><div class="{{CSS.ICON}}" title="{{get_string "brush4" component}}"><div class="{{CSS.BRUSH}} {{CSS.BRUSH4}}" title="{{get_string "brush4" component}}"></div></div></td</tr></tbody></table></div><div class="{{CSS.COLOURGROUP}}"><h4 class="{{CSS.PALLETSECTIONTITLE}}">{{get_string "title_colours" component}}</h4><table><tbody><tr><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR1}}" title="{{get_string "colour1" component}}"></div></div></td><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR2}}" title="{{get_string "colour2" component}}"></div></div></td</tr><tr><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR3}}" title="{{get_string "colour3" component}}"></div></div></td><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR4}}" title="{{get_string "colour4" component}}"></div></div></td</tr><tr><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR5}}" title="{{get_string "colour5" component}}"></div></div></td><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR6}}" title="{{get_string "colour6" component}}"></div></div></td</tr><tr><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR7}}" title="{{get_string "colour7" component}}"></div></div></td><td><div class="{{CSS.ICON}}"><div class="{{CSS.COLOUR}} {{CSS.COLOUR8}}" title="{{get_string "colour8" component}}"></div></div></td</tr></tbody></table></div></div><input type="hidden" class="{{CSS.INPUTALT}}" value="" id="{{elementid}}_{{CSS.INPUTALT}}" /><input type="hidden" class="{{CSS.INPUTWIDTH}}" value="" id="{{elementid}}_{{CSS.INPUTWIDTH}}" /><input type="hidden" class="{{CSS.INPUTHEIGHT}}" value="" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" /><input type="hidden" class="{{CSS.INPUTALIGNMENT}}" value="" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}" /></form>',u='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}/>';e.namespace("M.atto_racsdrawing"
).Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_mouse:{x:null,y:null},_lastMouse:{x:null,y:null},_strokeWidth:null,_strokeColour:null,_colour:null,_selectedTool:null,initializer:function(){this.addButton({icon:"icon",iconComponent:n,callback:this._displayDialogue,tags:"drawing",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"auto",focusAfterHide:!0});e.set("bodyContent",this._getDialogueContent()).show()},_getDialogueContent:function(){var t=e.Handlebars.compile(o),i=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:r,component:n}));return this._form=i,this._applyImageProperties(this._form),this._strokeWidth=null,this._strokeColour=null,this._form.all("."+r.TOOL).each(function(e){e.ancestor().on("click",this._eventSetTool,this,e)},this),this._form.all("."+r.BRUSH).each(function(e){e.ancestor().on("click",this._eventSetLineWidth,this,e)},this),this._form.all("."+r.COLOUR).each(function(e){e.ancestor().on("click",this._eventSetLineColour,this,e)},this),this._form.one("."+r.CANVAS).on("mousedown",this._draw,this),this._form.one("."+r.CANVAS).on("mousemove",this._updateMousePosition,this),i},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),n;if(t===!1)return;t.align&&e.one("."+r.INPUTALIGNMENT).set("value",t.align),t.width&&e.one("."+r.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+r.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+r.INPUTALT).set("value",t.alt),t.src&&(n=new Image,n.src=t.src,e.one("."+r.CANVAS).setAttribute("height",n.height),e.one("."+r.CANVAS).setAttribute("width",n.width),e.one("."+r.CANVAS)._node.getContext("2d").drawImage(n,0,0))},_setImage:function(){var t=this._form,n=t.one("."+r.CANVAS)._node.toDataURL(),i=t.one("."+r.INPUTALT).get("value"),o=t.one("."+r.INPUTWIDTH).get("value"),a=t.one("."+r.INPUTHEIGHT).get("value"),f=t.one("."+r.INPUTALIGNMENT).get("value"),l="",c,h,p,d,v=[],m=this.get("host");m.focus(),this._selectedImage?m.setSelection(m.getSelectionFromNode(this._selectedImage)):m.setSelection(this._currentSelection);for(h in s)p=s[h].value+":"+s[h].name+";",f===p&&(l=" margin: "+s[h].margin+";");d=e.Handlebars.compile(u),c=d({url:n,alt:i,width:o,height:a,alignment:f,margin:l,classlist:v.join(" ")}),this.get("host").insertContentAtFocusPoint(c),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,o,u,a,f,l;t&&(t=t.filter("img"));if(t&&t.size()){f=t.item(0),this._selectedImage=f,u=f.getAttribute("style"),e.customstyle=u,u=u.replace(/ /g,""),r=f.getAttribute("width"),r.match(i.ISPERCENT)||(r=parseInt(r,10)),o=f.getAttribute("height"),o.match(i.ISPERCENT)||(o=parseInt(o,10)),r!==0&&(e.width=r),o!==0&&(e.height=o);for(n in s){a=s[n].value+":"+s[n].name+";";if(u.indexOf(a)!==-1){l="margin:"+s[n].margin+";",l=l.replace(/ /g,"");if(u.indexOf(l)!==-1){e.align=a;break}}}return e.src=f.getAttribute("src"),e.alt=f.getAttribute("alt")||"",e}return this._selectedImage=null,!1},_draw:function(){switch(this._selectedTool){case"erase":this._lineSetColour("white"),this._setupDrawLine();break;case"draw":this._lineSetColour(this._colour),this._setupDrawLine();break;case"box":break;case"text":break;case"save":break;case"cancel":}},_setupDrawLine:function(){if(this._strokeWidth===null||this._strokeColour===null)return;var e=this._form.one("."+r.CANVAS),t,n=e._node,i=this;this._lastMouse={x:this._mouse.x,y:this._mouse.y},t=setInterval(function(){i._drawLine(n.getContext("2d"))},10),e.on("mouseup",function(){clearInterval(this)},t),e.on("mouseleave",function(){clearInterval(this)},t)},_updateMousePosition:function(e){var t=this._form.one("."+r.CANVAS)._node,n=this._getMousePosition(e,t);this._mouse.x=n.x,this._mouse.y=n.y},_getMousePosition:function(e,t){var n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},_drawLine:function(e){e.beginPath(),e.moveTo(this._lastMouse.x,this._lastMouse.y),e.lineTo(this._mouse.x,this._mouse.y),e.lineCap="round",e.lineWidth=this._strokeWidth,e.strokeStyle=this._strokeColour,e.stroke(),this._lastMouse={x:this._mouse.x,y:this._mouse.y}},_eventSetLineColour:function(e,t){var n=this._form.one("."+r.SELECTEDCOLOUR),i=t.getStyle("backgroundColor");n!==null&&n.removeClass(r.SELECTEDCOLOUR),t.ancestor().addClass(r.SELECTEDCOLOUR),this._setColour(i)},_lineSetColour:function(e){this._strokeColour=e},_setColour:function(e){this._colour=e},_eventSetLineWidth:function(e,t){var n=this._form.one("."+r.SELECTEDBRUSHSIZE),i=t.getStyle("width");n!==null&&n.removeClass(r.SELECTEDBRUSHSIZE),t.ancestor().addClass(r.SELECTEDBRUSHSIZE),i.indexOf("px")!==-1&&(i=i.substring(0,i.length-2)),this._lineSetWidth(i)},_lineSetWidth:function(e){this._strokeWidth=e},_eventSetTool:function(e,t){var n=this._form.one("."+r.SELECTEDTOOL),i=t.getData("tool");n!==null&&n.removeClass(r.SELECTEDTOOL),t.ancestor().addClass(r.SELECTEDTOOL),this._selectedTool=i;switch(i){case"erase":this._lineSetColour("white");break;case"draw":break;case"box":break;case"text":break;case"save":this._setImage();break;case"cancel":}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","button-group"]});
