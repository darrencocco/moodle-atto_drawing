YUI.add("moodle-atto_racsdrawing-button",function(e,t){var n="atto_racsdrawing",r={DRAWLINE:"atto_racsdrawing_drawline",ERASER:"atto_racsdrawing_eraser",CANVAS:"atto_racsdrawing_canvas",DONE:"atto_racsdrawing_done",INPUTALT:"atto_racsdrawing_inputalt",INPUTWIDTH:"atto_racsdrawing_inputwidth",INPUTHEIGHT:"atto_racsdrawing_inputheight",INPUTALIGNMENT:"atto_racsdrawing_inputalignment",TOOLS:"atto_racsdrawing_toolspallet",FORM:"atto_racsdrawing_form",TOOLSGROUP:"atto_racsdrawing_tools",BRUSHSIZEGROUP:"atto_racsdrawing_brushes",SMALLBRUSH:"atto_racsdrawing_smallbrush",MEDIUMBRUSH:"atto_racsdrawing_mediumbrush",LARGEBRUSH:"atto_racsdrawing_largebrush"},i={ISPERCENT:/\d+%/},s=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],o={WHITE:"#FFFFFF",BLACK:"#000000"},u={SMALL:3,MEDIUM:8,LARGE:12},a='<form class="{{CSS.FORM}} atto_form"><canvas class="{{CSS.CANVAS}}" width="800" height="600"></canvas><div class="{{CSS.TOOLS}}"><div class="{{CSS.TOOLSGROUP}}"><button class="{{CSS.DRAWLINE}} radio" type="button" title="{{get_string "draw_line" component}}"><img class="icon" aria-hidden="true" role="presentation" width="32" height="32" src="{{image_url "pencil" component}}"/></button><button class="{{CSS.ERASER}} radio" type="button" title="{{get_string "eraser" component}}"><img class="icon" aria-hidden="true" role="presentation" width="32" height="32" src="{{image_url "eraser" component}}"/></button></div><div class="{{CSS.BRUSHSIZEGROUP}}"><button class="{{CSS.SMALLBRUSH}} radio" type="button" title="{{get_string "small_brush" component}}"><img class="icon" aria-hidden="true" role="presentation" width="32" height="32" src="{{image_url "small_brush" component}}"/></button><button class="{{CSS.MEDIUMBRUSH}} radio" type="button" title="{{get_string "medium_brush" component}}"><img class="icon" aria-hidden="true" role="presentation" width="32" height="32" src="{{image_url "medium_brush" component}}"/></button><button class="{{CSS.LARGEBRUSH}} radio" type="button" title="{{get_string "large_brush" component}}"><img class="icon" aria-hidden="true" role="presentation" width="32" height="32" src="{{image_url "large_brush" component}}"/></button></div></div><button class="{{CSS.DONE}}" type="button">{{get_string "save_complete" component}}</button><input type="hidden" class="{{CSS.INPUTALT}}" value="" id="{{elementid}}_{{CSS.INPUTALT}}" /><input type="hidden" class="{{CSS.INPUTWIDTH}}" value="" id="{{elementid}}_{{CSS.INPUTWIDTH}}" /><input type="hidden" class="{{CSS.INPUTHEIGHT}}" value="" id="{{elementid}}_{{CSS.INPUTHEIGHT}}" /><input type="hidden" class="{{CSS.INPUTALIGNMENT}}" value="" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}" /></form>',f='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}/>';e.namespace("M.atto_racsdrawing").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_mouse:{x:null,y:null},_lastMouse:{x:null,y:null},_strokeWidth:null,_strokeColour:null,initializer:function(){this.addButton({icon:"icon",iconComponent:n,callback:this._displayDialogue,tags:"drawing",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"auto",focusAfterHide:!0});e.set("bodyContent",this._getDialogueContent()).show(),this.colourButtonGroup.render(),this.widthButtonGroup.render()},_getDialogueContent:function(){var t=e.Handlebars.compile(a),i=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:r,component:n,COLOUR:o}));return this._form=i,this._applyImageProperties(this._form),this._strokeWidth=null,this._strokeColour=null,this._form.one("."+r.DRAWLINE).on("click",this._eventSetLineColour,this,o.BLACK),this._form.one("."+r.ERASER).on("click",this._eventSetLineColour,this,o.WHITE),this._form.one("."+r.SMALLBRUSH).on("click",this._eventSetLineWidth,this,u.SMALL),this._form.one("."+r.MEDIUMBRUSH).on("click",this._eventSetLineWidth,this,u.MEDIUM),this._form.one("."+r.LARGEBRUSH).on("click",this._eventSetLineWidth,this,u.LARGE),this._form.one("."+r.DONE).on("click",this._setImage,this),this._form.one("."+r.CANVAS).on("mousedown",this._draw,this),this._form.one("."+r.CANVAS).on("mousemove",this._updateMousePosition,this),this.colourButtonGroup=new e.ButtonGroup({srcNode:this._form.one("."+r.TOOLSGROUP),type:"radio"}),this.widthButtonGroup=new e.ButtonGroup({srcNode:this._form.one("."+r.BRUSHSIZEGROUP),type:"radio"}),i},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),n;if(t===!1)return;t.align&&e.one("."+r.INPUTALIGNMENT).set("value",t.align),t.width&&e.one("."+r.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+r.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+r.INPUTALT).set("value",t.alt),t.src&&(n=new Image,n.src=t.src,e.one("."+r.CANVAS).setAttribute("height",n.height),e.one("."+r.CANVAS).setAttribute("width",n.width),e.one("."+r.CANVAS)._node.getContext("2d").drawImage(n,0,0))},_setImage:function(t){var n=this._form,i=n.one("."+r.CANVAS)._node.toDataURL(),o=n.one("."+r.INPUTALT).get("value"),u=n.one("."+r.INPUTWIDTH).get("value"),a=n.one("."+r.INPUTHEIGHT).get("value"),l=n.one("."+r.INPUTALIGNMENT).get("value"),c="",h,p,d,v,m=[],g=this.get("host");t.preventDefault(),g.focus(),this._selectedImage?g.setSelection(g.getSelectionFromNode
(this._selectedImage)):g.setSelection(this._currentSelection);for(p in s)d=s[p].value+":"+s[p].name+";",l===d&&(c=" margin: "+s[p].margin+";");v=e.Handlebars.compile(f),h=v({url:i,alt:o,width:u,height:a,alignment:l,margin:c,classlist:m.join(" ")}),this.get("host").insertContentAtFocusPoint(h),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,o,u,a,f,l;t&&(t=t.filter("img"));if(t&&t.size()){f=t.item(0),this._selectedImage=f,u=f.getAttribute("style"),e.customstyle=u,u=u.replace(/ /g,""),r=f.getAttribute("width"),r.match(i.ISPERCENT)||(r=parseInt(r,10)),o=f.getAttribute("height"),o.match(i.ISPERCENT)||(o=parseInt(o,10)),r!==0&&(e.width=r),o!==0&&(e.height=o);for(n in s){a=s[n].value+":"+s[n].name+";";if(u.indexOf(a)!==-1){l="margin:"+s[n].margin+";",l=l.replace(/ /g,"");if(u.indexOf(l)!==-1){e.align=a;break}}}return e.src=f.getAttribute("src"),e.alt=f.getAttribute("alt")||"",e}return this._selectedImage=null,!1},_draw:function(){var e=this._form.one("."+r.CANVAS),t,n=e._node,i=this;if(this._strokeWidth===null||this._strokeColour===null)return;this._lastMouse={x:this._mouse.x,y:this._mouse.y},t=setInterval(function(){i._drawLine(n.getContext("2d"))},10),e.on("mouseup",function(){clearInterval(this)},t),e.on("mouseleave",function(){clearInterval(this)},t)},_updateMousePosition:function(e){var t=this._form.one("."+r.CANVAS)._node,n=this._getMousePosition(e,t);this._mouse.x=n.x,this._mouse.y=n.y},_getMousePosition:function(e,t){var n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},_drawLine:function(e){e.beginPath(),e.moveTo(this._lastMouse.x,this._lastMouse.y),e.lineTo(this._mouse.x,this._mouse.y),e.lineCap="round",e.lineWidth=this._strokeWidth,e.strokeStyle=this._strokeColour,e.stroke(),this._lastMouse={x:this._mouse.x,y:this._mouse.y}},_eventSetLineColour:function(e,t){this._lineSetColour(t)},_lineSetColour:function(e){this._strokeColour=e},_eventSetLineWidth:function(e,t){this._lineSetWidth(t)},_lineSetWidth:function(e){this._strokeWidth=e}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","button-group"]});
