YUI.add("moodle-atto_racsdrawing-button",function(e,t){var n="atto_racsdrawing",r="atto_racsdrawing",i={DRAWLINE:"atto_racsdrawing_drawline",ERASER:"atto_racsdrawing_eraser",CANVAS:"atto_racsdrawing_canvas",DONE:"atto_racsdrawing_done",INPUTALT:"atto_racsdrawing_inputalt",INPUTSIZE:"atto_racsdrawing_inputsize",INPUTHEIGHT:"atto_racsdrawing_inputheight"},s={ISPERCENT:/\d+%/},o=[{name:"text-top",str:"alignment_top",value:"vertical-align",margin:"0 .5em"},{name:"middle",str:"alignment_middle",value:"vertical-align",margin:"0 .5em"},{name:"text-bottom",str:"alignment_bottom",value:"vertical-align",margin:"0 .5em",isDefault:!0},{name:"left",str:"alignment_left",value:"float",margin:"0 .5em 0 0"},{name:"right",str:"alignment_right",value:"float",margin:"0 0 0 .5em"},{name:"customstyle",str:"customstyle",value:"style"}],u='<form class="atto_form"><button class="{{CSS.DRAWLINE}}" type="button">{{get_string "draw_line" component}}</button><button class="{{CSS.ERASER}}" type="button">{{get_string "eraser" component}}</button><canvas class="{{CSS.CANVAS}}" width="800" height="600"></canvas><button class="{{CSS.DONE}}" type="button">{{get_string "save_complete" component}}</button><input type="hidden" class={{CSS.INPUTALT}} value="" id="{{elementid}}_{{CSS.INPUTALT}} /><input type="hidden" class={{CSS.INPUTSIZE}} value="" id="{{elementid}}_{{CSS.INPUTSIZE}} /><input type="hidden" class={{CSS.INPUTHEIGHT}} value="" id="{{elementid}}_{{CSS.INPUTHEIGHT}} /><input type="hidden" class={{CSS.INPUTALT}} value="" id="{{elementid}}_{{CSS.INPUTALT}} /></form>',a='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}style="{{alignment}}{{margin}}{{customstyle}}"{{#if classlist}}class="{{classlist}}" {{/if}}/>';e.namespace("M.atto_racsdrawing").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:"drawing",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawImageDimensions=null;var e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"900px",focusAfterHide:!0});e.set("bodyContent",this._getDialogueContent()).show()},_getDialogueContent:function(){var t=e.Handlebars.compile(u),r=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:i,component:n}));return this._form=r,this._applyImageProperties(this._form),this._form.one("."+i.DRAWLINE).on("click",this._drawLineEnabled,this,"#000000"),this._form.one("."+i.ERASER).on("click",this._drawLineEnabled,this,"#FFFFFF"),this._form.one("."+i.DONE).on("click",this._setImage,this),r},_applyImageProperties:function(e){var t=this._getSelectedImageProperties(),n,r,s;if(t===!1)return;t.align&&e.one("."+i.INPUTALIGNMENT).set("value",t.align),t.width&&e.one("."+i.INPUTWIDTH).set("value",t.width),t.height&&e.one("."+i.INPUTHEIGHT).set("value",t.height),t.alt&&e.one("."+i.INPUTALT).set("value",t.alt),t.src&&(r=new Image,r.src=t.src,e.one("."+i.CANVAS)._node.getContext("2d").drawImage(r,0,0))},_setImage:function(t){var n=this._form,r=n.one("."+i.CANVAS)._node.toDataURL(),u=n.one("."+i.INPUTALT).get("value"),f=n.one("."+i.INPUTWIDTH).get("value"),l=n.one("."+i.INPUTHEIGHT).get("value"),c=n.one("."+i.INPUTALIGNMENT).get("value"),h="",p,d="",v,m,g=[],y=this.get("host");t.preventDefault(),y.focus(),this._selectedImage?y.setSelection(y.getSelectionFromNode(this._selectedImage)):y.setSelection(this._currentSelection);for(v in o)css=o[v].value+":"+o[v].name+";",c===css&&(h=" margin: "+o[v].margin+";");if(!f.match(s.ISPERCENT)&&isNaN(parseInt(f,10))){n.one("."+i.INPUTWIDTH).focus();return}if(!l.match(s.ISPERCENT)&&isNaN(parseInt(l,10))){n.one("."+i.INPUTHEIGHT).focus();return}m=e.Handlebars.compile(a),p=m({url:r,alt:u,width:f,height:l,alignment:c,margin:h,classlist:g.join(" ")}),this.get("host").insertContentAtFocusPoint(p),this.markUpdated(),this.getDialogue({focusAfterHide:null}).hide()},_getSelectedImageProperties:function(){var e={src:null,alt:null,width:null,height:null,align:"",presentation:!1},t=this.get("host").getSelectedNodes(),n,r,i,u,a,f,l;t&&(t=t.filter("img"));if(t&&t.size()){f=t.item(0),this._selectedImage=f,u=f.getAttribute("style"),e.customstyle=u,u=u.replace(/ /g,""),r=f.getAttribute("width"),r.match(s.ISPERCENT)||(r=parseInt(r,10)),i=f.getAttribute("height"),i.match(s.ISPERCENT)||(i=parseInt(i,10)),r!==0&&(e.width=r),i!==0&&(e.height=i);for(n in o){a=o[n].value+":"+o[n].name+";";if(u.indexOf(a)!==-1){l="margin:"+o[n].margin+";",l=l.replace(/ /g,"");if(u.indexOf(l)!==-1){e.align=a;break}}}return e.src=f.getAttribute("src"),e.alt=f.getAttribute("alt")||"",e.presentation=f.get("role")==="presentation",e}return this._selectedImage=null,!1}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
